# -*- coding: utf-8 -*-
"""streamlit_app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QTz5AEMhMHderPiPEXHd_yZ8z0v5tjkF
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib

# --- CONFIGURACIÃ“N DE LA PÃGINA ---
st.set_page_config(page_title="PredicciÃ³n de Reservas", page_icon="ğŸ¨", layout="wide")

# --- CARGA DE ARTEFACTOS ---
@st.cache_resource
def load_artifacts():
    try:
        # Cargamos solo el modelo, que al parecer ya incluye el pipeline dentro
        model = joblib.load('modelo_hotel_booking.sav')
        return model
    except FileNotFoundError:
        return None

model = load_artifacts()

if model is None:
    st.error("âš ï¸ Error: No se encontrÃ³ el archivo 'modelo_hotel_booking.sav'. AsegÃºrate de que estÃ© en la misma carpeta.")
    st.stop()
else:
    st.sidebar.success("Sistema listo para predecir")

# --- INTERFAZ DE USUARIO ---
st.title("ğŸ¨ PredicciÃ³n de CancelaciÃ³n de Hotel")
st.markdown("Esta aplicaciÃ³n predice la probabilidad de cancelaciÃ³n basada en las caracterÃ­sticas de la reserva.")

# --- FORMULARIO DE ENTRADA ---
st.sidebar.header("ğŸ“ Detalles de la Reserva")

def user_input_features():
    # --- 1. DATOS PRINCIPALES (Visibles para el usuario) ---

    hotel = st.sidebar.selectbox("Tipo de Hotel", ['Resort Hotel', 'City Hotel'])
    lead_time = st.sidebar.slider("DÃ­as de anticipaciÃ³n (Lead Time)", 0, 700, 30)

    col1, col2 = st.sidebar.columns(2)
    with col1:
        arrival_date_month = st.selectbox("Mes de llegada",
            ['January', 'February', 'March', 'April', 'May', 'June',
             'July', 'August', 'September', 'October', 'November', 'December'])
        adults = st.number_input("Adultos", 1, 10, 2)
        children = st.number_input("NiÃ±os", 0, 10, 0)
        babies = st.number_input("BebÃ©s", 0, 5, 0)

    with col2:
        stays_in_weekend_nights = st.number_input("Noches Fin de Semana", 0, 10, 2)
        stays_in_week_nights = st.number_input("Noches Entre Semana", 0, 20, 3)
        total_of_special_requests = st.number_input("Peticiones Especiales", 0, 5, 0)
        required_car_parking_spaces = st.number_input("Estacionamiento", 0, 5, 0)

    meal = st.sidebar.selectbox("RÃ©gimen de Comidas", ['BB', 'FB', 'HB', 'SC', 'Undefined'])
    country = st.sidebar.text_input("PaÃ­s de Origen (CÃ³digo ISO)", "PRT")
    market_segment = st.sidebar.selectbox("Segmento de Mercado", ['Online TA', 'Offline TA/TO', 'Groups', 'Direct', 'Corporate', 'Complementary', 'Aviation'])
    distribution_channel = st.sidebar.selectbox("Canal de DistribuciÃ³n", ['TA/TO', 'Direct', 'Corporate', 'GDS', 'Undefined'])

    is_repeated_guest = st.sidebar.selectbox("Â¿HuÃ©sped Repetido?", [0, 1], format_func=lambda x: "SÃ­" if x == 1 else "No")
    previous_cancellations = st.sidebar.number_input("Cancelaciones Previas", 0, 10, 0)
    previous_bookings_not_canceled = st.sidebar.number_input("Reservas Previas NO Canceladas", 0, 10, 0)

    reserved_room_type = st.sidebar.selectbox("HabitaciÃ³n Reservada", ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'L', 'P'])
    assigned_room_type = st.sidebar.selectbox("HabitaciÃ³n Asignada", ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'L', 'P'], index=0) # Por defecto la misma

    booking_changes = st.sidebar.number_input("Cambios en la Reserva", 0, 10, 0)
    deposit_type = st.sidebar.selectbox("Tipo de DepÃ³sito", ['No Deposit', 'Non Refund', 'Refundable'])
    customer_type = st.sidebar.selectbox("Tipo de Cliente", ['Transient', 'Contract', 'Transient-Party', 'Group'])
    adr = st.sidebar.number_input("Tarifa Diaria (ADR)", 0.0, 1000.0, 100.0)

    # --- 2. DATOS DE RELLENO (Dummy values) ---
    agent = 9.0
    company = 0.0
    days_in_waiting_list = 0
    arrival_date_year = 2017
    arrival_date_week_number = 27
    arrival_date_day_of_month = 15

    data = {
        'hotel': hotel,
        'is_canceled': 0,
        'lead_time': lead_time,
        'arrival_date_year': arrival_date_year,
        'arrival_date_month': arrival_date_month,
        'arrival_date_week_number': arrival_date_week_number,
        'arrival_date_day_of_month': arrival_date_day_of_month,
        'stays_in_weekend_nights': stays_in_weekend_nights,
        'stays_in_week_nights': stays_in_week_nights,
        'adults': adults,
        'children': children,
        'babies': babies,
        'meal': meal,
        'country': country,
        'market_segment': market_segment,
        'distribution_channel': distribution_channel,
        'is_repeated_guest': is_repeated_guest,
        'previous_cancellations': previous_cancellations,
        'previous_bookings_not_canceled': previous_bookings_not_canceled,
        'reserved_room_type': reserved_room_type,
        'assigned_room_type': assigned_room_type,
        'booking_changes': booking_changes,
        'deposit_type': deposit_type,
        'agent': agent,
        'company': company,
        'days_in_waiting_list': days_in_waiting_list,
        'customer_type': customer_type,
        'adr': adr,
        'required_car_parking_spaces': required_car_parking_spaces,
        'total_of_special_requests': total_of_special_requests,
        'reservation_status': 'Check-Out',
        'reservation_status_date': '2017-07-01'
    }

    features = pd.DataFrame(data, index=[0])
    return features

input_df = user_input_features()

# --- PANEL PRINCIPAL ---
st.subheader("ğŸ“‹ Resumen de Datos")
st.dataframe(input_df)

if st.button("ğŸ”® Calcular Probabilidad"):
    try:
        # CORRECCIÃ“N: Pasamos el DataFrame DIRECTO al modelo.
        prediction_proba = model.predict_proba(input_df)

        # --- FIX: Convertir numpy.float32 a python float ---
        cancel_prob = float(prediction_proba[0][1])

        st.divider()
        col_res1, col_res2 = st.columns([1, 2])

        with col_res1:
            if cancel_prob > 0.5:
                st.error("ğŸ›‘ ALTA Probabilidad")
                st.metric(label="Riesgo de CancelaciÃ³n", value=f"{cancel_prob:.1%}", delta="Alto Riesgo", delta_color="inverse")
            else:
                st.success("âœ… BAJA Probabilidad")
                st.metric(label="Riesgo de CancelaciÃ³n", value=f"{cancel_prob:.1%}", delta="Seguro")

        with col_res2:
            # Ahora sÃ­, st.progress recibirÃ¡ un float normal y no fallarÃ¡
            st.progress(cancel_prob, text="Nivel de Riesgo")

            if cancel_prob > 0.5:
                st.info("ğŸ’¡ Sugerencia: Contactar al cliente para confirmar llegada o solicitar depÃ³sito.")
            else:
                st.info("ğŸ’¡ Sugerencia: Reserva aparentemente segura.")

    except Exception as e:
        st.error(f"OcurriÃ³ un error: {e}")
        st.write("Detalles tÃ©cnicos:", e)